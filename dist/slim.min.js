function S(t){let e=new URLSearchParams,r=t,a=[];for(;r;)a.unshift(r),r=r.parentElement;for(let u of a){let l=u.getAttribute("s-query");l&&new URLSearchParams(l).forEach((g,v)=>e.set(v,g))}return e}function w(t,e){if(e.toString()==="")return t;let r=new URL(t,location.origin);return e.forEach((a,u)=>{r.searchParams.set(u,a)}),r.toString()}function b(t,e,r){if(t.headers.get("S-Refresh")==="true")return location.reload(),Promise.resolve({status:t.status,html:null,text:null,event:null,targets:[]});if(!t.ok)return Promise.reject();let u=t.headers.get("S-Target")||r,l=t.headers.get("S-Emit");return t.text().then(f=>{switch(t.headers.get("content-type")?.split(";")[0]){case"text/html":return{status:t.status,html:f,text:null,event:l,targets:x(e,u)};case"text/plain":return{status:t.status,html:null,text:f,event:l,targets:[]};default:return{status:t.status,html:null,text:null,event:l,targets:[]}}})}function x(t,e){if(!e)return[t];let r=document.querySelectorAll(e);return Array.from(r)}function R(t,e,r){let a=new FormData(t);if(e.toUpperCase()==="GET"){let u=L(r);for(let[l,f]of a.entries())f instanceof File||u.searchParams.append(l,f.toString());return{url:u.toString(),body:null}}else return{url:r,body:a}}function L(t){return t.startsWith("http")?new URL(t):new URL(t,location.origin)}function C(t,e,r,a){let{url:u,body:l}=R(r,e,t),f={method:e};return l&&(f.body=l),fetch(u,f).then(g=>b(g,r,a))}function T(t,e,r){let a=r.getAttribute("s-target");return r instanceof HTMLFormElement?C(t,e,r,a):fetch(t,{method:e}).then(u=>b(u,r,a))}function y(t){let e=t.getAttribute("s-on");return e?e.split(/\s*\|\s*/).map(q).filter(Boolean):k(t)}function k(t){switch(t.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[{event:"appear"}]}}function q(t){let e=t.split(/\s+on\s+/);return e.length===1?{event:e[0]}:e.length===2?{event:e[0],selector:e[1]}:(console.warn(`Invalid event spec: ${t}`),null)}(function(){let t;function e(n,o){let s=n.getAttribute(`s-${o}`);return s?{url:s,method:o}:null}function r(n=document.body){return n.querySelectorAll("[s-get],[s-post],[s-put],[s-delete],[s-emit]")}function a(n){let o=n instanceof Event?n:new CustomEvent(n),s=r(),m=[],h=[];for(let c of s){let i=c.getAttribute("s-emit"),p=u(c);if(!i&&!p)continue;let d=y(c);for(let E of d)E.event===o.type&&(E.selector?m.push({element:c,emit:i,config:p,spec:E}):h.push({element:c,emit:i,config:p,spec:E}))}if(o.target&&o.target instanceof Element){let c=o.target;for(;c;){let i=h.find(d=>d.element.isSameNode(c));i&&l(i);let p=m.filter(d=>c.matches(d.spec.selector));for(let d of p)l(d);if(c.parentElement)c=c.parentElement;else break}}else for(let c of[...m,...h])c.spec.event===o.type&&l(c)}function u(n){return e(n,"get")??e(n,"post")??e(n,"put")??e(n,"delete")}function l({element:n,config:o,emit:s}){let m=n.getAttribute("s-confirm");if(m&&!confirm(m))return;let h=S(n);if(s&&a(s),o){let c=w(o.url,h);T(c,o.method,n).then(i=>{if(i.html!==null)for(let p of i.targets)p.innerHTML=i.html,v(p);else if(i.text!==null)for(let p of i.targets)p.textContent=i.text;else i.event&&a(i.event);n.dispatchEvent(new CustomEvent("slim:ok"))}).catch(i=>{console.error("Request failed:",i),n.dispatchEvent(new CustomEvent("slim:error"))}).finally(()=>{n.dispatchEvent(new CustomEvent("slim:done"))})}}function f(n){for(let o of n)if(o.isIntersecting){let s=o.target;s.dispatchEvent(new CustomEvent("appear")),t.unobserve(s)}}function g(){let n={root:null,threshold:0};t=new IntersectionObserver(f,n)}function v(n){let o=r(n);for(let s of o)y(s).some(c=>c.event==="appear")&&t.observe(s)}function A(){let n=["click","change","input","submit","appear"];for(let o of n)document.body.addEventListener(o,s=>{s.type==="submit"&&s.preventDefault(),a(s)},{capture:!0})}function P(){let n=document.body.getAttribute("s-ws");if(!n)return;let o=new WebSocket(n);o.onmessage=s=>{let m=s.data.toString();a(m)},o.onerror=s=>{console.error("WebSocket error:",s)},o.onclose=()=>{console.log("WebSocket connection closed")}}document.addEventListener("DOMContentLoaded",()=>{g(),A(),P(),v(document.body)})})();
