function w(t){let e=new URLSearchParams,n=t,o=[];for(;n;)o.unshift(n),n=n.parentElement;for(let f of o){let a=f.getAttribute("s-query");a&&new URLSearchParams(a).forEach((d,v)=>e.set(v,d))}return e}function A(t,e){if(e.toString()==="")return t;let n=new URL(t,location.origin);return e.forEach((o,f)=>{n.searchParams.set(f,o)}),n.toString()}function y(t,e,n){if(t.headers.get("S-Refresh")==="true")return location.reload(),Promise.resolve({status:t.status,html:null,text:null,event:null,targets:[]});if(!t.ok)return Promise.reject();let f=t.headers.get("S-Target")||n,a=t.headers.get("S-Emit");return t.text().then(l=>{let v=t.headers.get("content-type")?.split(";")[0],E=R(e,f);switch(v){case"text/html":return{status:t.status,html:l,text:null,event:a,targets:E};case"text/plain":return{status:t.status,html:null,text:l,event:a,targets:E};default:return{status:t.status,html:null,text:null,event:a,targets:[]}}})}function R(t,e){if(!e)return[t];let n=document.querySelectorAll(e);return Array.from(n)}function C(t,e,n){let o=new FormData(t);if(e.toUpperCase()==="GET"){let f=D(n);for(let[a,l]of o.entries())l instanceof File||f.searchParams.append(a,l.toString());return{url:f.toString(),body:null}}else return{url:n,body:o}}function D(t){return t.startsWith("http")?new URL(t):new URL(t,location.origin)}function k(t,e,n,o){let{url:f,body:a}=C(n,e,t),l={method:e};return a&&(l.body=a),fetch(f,l).then(d=>y(d,n,o))}function x(t,e,n,o){let f=o.getAttribute("s-target");if(o instanceof HTMLFormElement)return k(e,n,o,f);{let a={},l;if(t instanceof DragEvent){let d=t.dataTransfer?.getData("application/json");d&&(a["Content-Type"]="application/json",l=d)}return fetch(e,{method:n,headers:a,body:l}).then(d=>y(d,o,f))}}function S(t){let e=t.getAttribute("s-on");return e?e.split(/\s*\|\s*/).map(U).filter(Boolean):q(t)}function q(t){switch(t.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[{event:"appear"}]}}function U(t){let e=t.split(/\s+on\s+/);return e.length===1?{event:e[0]}:e.length===2?{event:e[0],selector:e[1]}:(console.warn(`Invalid event spec: ${t}`),null)}function P(t,e){if(!(e instanceof DragEvent)||!e.dataTransfer)return;if(e.type==="dragstart"){let f=t.getAttribute("s-drag-json"),a=t.getAttribute("s-drag-effect");f&&e.dataTransfer.setData("application/json",f),a&&(e.dataTransfer.effectAllowed=a)}let n=t.getAttribute("s-drop-class"),o=t.getAttribute("s-drop-effect");if(e.type==="dragover"){if(!o)return;e.preventDefault(),e.dataTransfer.dropEffect,n&&t.classList.add(n)}else e.type==="dragleave"&&n&&t.classList.remove(n)}(function(){let t;function e(s,r){let c=s.getAttribute(`s-${r}`);return c?{url:c,method:r}:null}function n(s=document.body){return s.querySelectorAll("[s-get],[s-post],[s-put],[s-delete],[s-emit]")}function o(s){let r=s instanceof Event?s:new CustomEvent(s),c=n(),g=[],m=[];for(let i of c){let h=i.getAttribute("s-emit"),u=f(i);if(!h&&!u)continue;let p=S(i);for(let b of p)b.event===r.type&&(b.selector?g.push({event:r,element:i,emit:h,config:u,spec:b}):m.push({event:r,element:i,emit:h,config:u,spec:b}))}if(r.target&&r.target instanceof Element){let i=r.target;for(P(i,r);i;){let h=m.find(p=>p.element.isSameNode(i));h&&a(h);let u=g.filter(p=>i.matches(p.spec.selector));for(let p of u)a(p);if(r.type==="appear")break;if(i.parentElement)i=i.parentElement;else break}}else for(let i of[...g,...m])i.spec.event===r.type&&a(i)}function f(s){return e(s,"get")??e(s,"post")??e(s,"put")??e(s,"delete")}function a({event:s,element:r,config:c,emit:g}){let m=r.getAttribute("s-confirm");if(m&&!confirm(m))return;let i=w(r);if(g&&o(g),c){let h=A(c.url,i);x(s,h,c.method,r).then(u=>{if(u.html!==null)for(let p of u.targets)p.innerHTML=u.html,v(p);else if(u.text!==null)for(let p of u.targets)p.textContent=u.text;else u.event&&o(u.event);r.dispatchEvent(new CustomEvent("slim:ok"))}).catch(u=>{console.error("Request failed:",u),r.dispatchEvent(new CustomEvent("slim:error"))}).finally(()=>{r.dispatchEvent(new CustomEvent("slim:done"))})}}function l(s){for(let r of s)if(r.isIntersecting){let c=r.target;c.dispatchEvent(new CustomEvent("appear",{bubbles:!1})),t.unobserve(c)}}function d(){let s={root:null,threshold:0};t=new IntersectionObserver(l,s)}function v(s){let r=n(s);for(let c of r)S(c).some(i=>i.event==="appear")&&t.observe(c)}function E(){let s=["click","change","input","submit","appear","dragstart","dragover","dragleave","drop"];for(let r of s)document.body.addEventListener(r,c=>{c.type==="submit"&&c.preventDefault(),o(c)},{capture:!0})}function L(s){let r=document.body.getAttribute("s-ws");if(!r)return;let c=new WebSocket(r);c.onmessage=g=>{let m=g.data.toString();o(m)},c.onerror=g=>{console.warn("WebSocket error:",g),s()}}function T(){L(()=>{setTimeout(()=>T(),1e3)})}document.addEventListener("DOMContentLoaded",()=>{d(),E(),T(),v(document.body)})})();
