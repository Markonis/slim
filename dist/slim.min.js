function q(t){let e=new URLSearchParams,n=t,r=[];for(;n;)r.unshift(n),n=n.parentElement;for(let c of r){let f=c.getAttribute("s-query");f&&new URLSearchParams(f).forEach((p,b)=>e.set(b,p))}if(t instanceof HTMLFormElement)return e;let s=Array.from(t.querySelectorAll("input, select, textarea")).reverse();for(let c of s){let f=c.getAttribute("name")??c.id;!f||!P(c)||e.set(f,c.value)}let a=t.getAttribute("name")??t.id;if(a){let c=P(t);c&&e.set(a,c)}return e}function P(t){return"value"in t?t.value:""}function H(t,e){if(e.toString()==="")return t;let n=new URL(t,location.origin);return e.forEach((r,s)=>{n.searchParams.set(s,r)}),n.toString()}function C(t,e,n,r){if(t.headers.get("S-Refresh")==="true")return location.reload(),Promise.resolve({status:t.status,html:null,text:null,event:null,targets:[],swapStrategy:r});if(!t.ok)return Promise.reject();let a=t.headers.get("S-Target")||n,c=t.headers.get("S-Emit"),d=t.headers.get("S-Swap")==="outer"?"outer":r;return t.text().then(p=>{let A=t.headers.get("content-type")?.split(";")[0],y=R(e,a);switch(A){case"text/html":return{status:t.status,html:p,text:null,event:c,targets:y,swapStrategy:d};case"text/plain":return{status:t.status,html:null,text:p,event:c,targets:y,swapStrategy:d};default:return{status:t.status,html:null,text:null,event:c,targets:[],swapStrategy:d}}})}function R(t,e){if(!e)return[t];let n=document.querySelectorAll(e);return Array.from(n)}function I(t,e,n){let r=new FormData(t);if(e.toUpperCase()==="GET"){let s=Q(n);for(let[a,c]of r.entries())c instanceof File||s.searchParams.append(a,c.toString());return{url:s.toString(),body:null}}else return{url:n,body:r}}function Q(t){return t.startsWith("http")?new URL(t):new URL(t,location.origin)}function B(t,e,n,r,s){let{url:a,body:c}=I(n,e,t),f={method:e};return c&&(f.body=c),fetch(a,f).then(d=>C(d,n,r,s))}function k(t){let{event:e,url:n,method:r,element:s,targetSelector:a,swapStrategy:c}=t;if(s instanceof HTMLFormElement)return B(n,r,s,a,c);{let f={},d;if(e instanceof DragEvent){let p=e.dataTransfer?.getData("application/json");p&&(f["Content-Type"]="application/json",d=p)}return fetch(n,{method:r,headers:f,body:d}).then(p=>C(p,s,a,c))}}function D(t){let e=t.getAttribute("s-on");return e?e.split(/\s*\|\s*/).map(G).filter(Boolean):V(t)}function V(t){switch(t.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[{event:"appear"}]}}function G(t){let e=t.split(/\s+on\s+/);return e.length===1?{event:e[0]}:e.length===2?{event:e[0],selector:e[1]}:(console.warn(`Invalid event spec: ${t}`),null)}function N(t,e){if(!(e instanceof DragEvent)||!e.dataTransfer)return;if(e.type==="dragstart"){let s=t.getAttribute("s-drag-json"),a=t.getAttribute("s-drag-effect");s&&e.dataTransfer.setData("application/json",s),a&&(e.dataTransfer.effectAllowed=a)}let n=t.getAttribute("s-drop-class"),r=t.getAttribute("s-drop-effect");if(e.type==="dragover"){if(!r)return;e.preventDefault(),e.dataTransfer.dropEffect,n&&t.classList.add(n)}else e.type==="dragleave"&&n&&t.classList.remove(n)}function O(t){let e=t.getAttribute("s-emit");if(!e)return null;let n=e.split(/\s+after\s/);if(n.length===2){let r=n[0],s=parseFloat(n[1]);return!r||isNaN(s)?null:(n[1].endsWith("s")&&(s*=1e3),s=Math.round(s),{event:r,delay:s})}else return{event:n[0],delay:0}}function F(t){return t.getAttribute("s-eval")}function M(t,e,n){try{new Function("event",t).call(e,n)}catch(r){console.error("s-eval execution failed:",r)}}function U(t){return t.getAttribute("s-swap")==="outer"?"outer":"inner"}function $(t,e,n){t.innerHTML=e,n(t)}function z(t,e,n){let r=document.createElement("div");r.innerHTML=e;let s=[];for(;r.firstChild;){let a=r.firstChild;a.nodeType===Node.ELEMENT_NODE&&s.push(a),t.parentElement&&t.parentElement.insertBefore(a,t)}t.parentElement&&t.parentElement.removeChild(t);for(let a of s)n(a)}function T(t){let{content:e,element:n,targetSelector:r,swapStrategy:s,observeElementsWithAppearEvent:a}=t,c=R(n,r);for(let f of c)s==="outer"?z(f,e,a):$(f,e,a)}function W(t){return t.getAttribute("s-template")}function j(t){let{element:e,templateSelector:n,targetSelector:r,swapStrategy:s,observeElementsWithAppearEvent:a}=t;if(!n)return;let c=document.querySelector(n);c&&T({content:c.innerHTML,element:e,targetSelector:r,swapStrategy:s,observeElementsWithAppearEvent:a})}(function(){let t;function e(i,o){let u=i.getAttribute(`s-${o}`);return u?{url:u,method:o}:null}function n(i=document.body){return i.querySelectorAll("[s-get],[s-post],[s-put],[s-delete],[s-emit],[s-eval],[s-template]")}function r(i){let o=i instanceof Event?i:new CustomEvent(i),u=n(),g=[],h=[];for(let l of u){let E=O(l),S=s(l),v=F(l),w=W(l),m=l.getAttribute("s-target");if(!E&&!S&&!v&&!w)continue;let x=D(l);for(let L of x){if(L.event!==o.type)continue;(L.selector?g:h).push({event:o,element:l,emitSpec:E,requestConfig:S,eventSpec:L,evalCode:v,templateSelector:w,targetSelector:m,swapStrategy:U(l)})}}if(o.target&&o.target instanceof Element){let l=o.target;for(N(l,o);l;){let E=h.find(v=>v.element.isSameNode(l));E&&a(E);let S=g.filter(v=>l.matches(v.eventSpec.selector));for(let v of S)a(v);if(o.type==="appear")break;if(l.parentElement)l=l.parentElement;else break}}else for(let l of[...g,...h])l.eventSpec.event===o.type&&a(l)}function s(i){return e(i,"get")??e(i,"post")??e(i,"put")??e(i,"delete")}function a({event:i,element:o,requestConfig:u,emitSpec:g,evalCode:h,templateSelector:l,targetSelector:E,swapStrategy:S}){let v=o.getAttribute("s-confirm");if(!(v&&!confirm(v))){if(h&&M(h,o,i),g&&c(o,g),u){let w={event:i,element:o,targetSelector:E,swapStrategy:S,method:u.method,url:H(u.url,q(o))};k(w).then(m=>{if(m.html!==null)T({content:m.html,element:o,targetSelector:E,swapStrategy:m.swapStrategy,observeElementsWithAppearEvent:p});else if(m.text!==null)for(let x of m.targets)x.textContent=m.text;else m.event&&r(m.event);o.dispatchEvent(new CustomEvent("slim:ok"))}).catch(m=>{console.error("Request failed:",m),o.dispatchEvent(new CustomEvent("slim:error"))}).finally(()=>{o.dispatchEvent(new CustomEvent("slim:done"))})}l&&j({element:o,templateSelector:l,targetSelector:E,swapStrategy:S,observeElementsWithAppearEvent:p})}}function c(i,o){o.delay?setTimeout(()=>{i.parentElement&&r(o.event)},o.delay):r(o.event)}function f(i){for(let o of i)if(o.isIntersecting){let u=o.target;u.dispatchEvent(new CustomEvent("appear",{bubbles:!1})),t.unobserve(u)}}function d(){let i={root:null,threshold:0};t=new IntersectionObserver(f,i)}function p(i){let o=n(i);for(let u of o)D(u).some(l=>l.event==="appear")&&t.observe(u)}function b(){let i=["click","change","input","submit","appear","dragstart","dragover","dragleave","drop"];for(let o of i)document.body.addEventListener(o,u=>{u.type==="submit"&&u.preventDefault(),r(u)},{capture:!0})}function A(i){let o=document.body.getAttribute("s-ws");if(!o)return;let u=new WebSocket(o);u.onmessage=g=>{let h=g.data.toString();r(h)},u.onerror=g=>{console.warn("WebSocket error:",g),i()}}function y(){A(()=>{setTimeout(()=>y(),1e3)})}document.addEventListener("DOMContentLoaded",()=>{d(),b(),y(),p(document.body)})})();
