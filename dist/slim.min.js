function P(t){let e=new URLSearchParams,n=t,o=[];for(;n;)o.unshift(n),n=n.parentElement;for(let c of o){let p=c.getAttribute("s-query");p&&new URLSearchParams(p).forEach((v,S)=>e.set(S,v))}if(t instanceof HTMLFormElement)return e;let a=Array.from(t.querySelectorAll("input, select, textarea")).reverse();for(let c of a){let p=c.getAttribute("name")??c.id;!p||!x(c)||e.set(p,c.value)}let l=t.getAttribute("name")??t.id;if(l){let c=x(t);c&&e.set(l,c)}return e}function x(t){return"value"in t?t.value:""}function L(t,e){if(e.toString()==="")return t;let n=new URL(t,location.origin);return e.forEach((o,a)=>{n.searchParams.set(a,o)}),n.toString()}function A(t,e,n){if(t.headers.get("S-Refresh")==="true")return location.reload(),Promise.resolve({status:t.status,html:null,text:null,event:null,targets:[]});if(!t.ok)return Promise.reject();let a=t.headers.get("S-Target")||n,l=t.headers.get("S-Emit");return t.text().then(c=>{let b=t.headers.get("content-type")?.split(";")[0],v=H(e,a);switch(b){case"text/html":return{status:t.status,html:c,text:null,event:l,targets:v};case"text/plain":return{status:t.status,html:null,text:c,event:l,targets:v};default:return{status:t.status,html:null,text:null,event:l,targets:[]}}})}function H(t,e){if(!e)return[t];let n=document.querySelectorAll(e);return Array.from(n)}function U(t,e,n){let o=new FormData(t);if(e.toUpperCase()==="GET"){let a=O(n);for(let[l,c]of o.entries())c instanceof File||a.searchParams.append(l,c.toString());return{url:a.toString(),body:null}}else return{url:n,body:o}}function O(t){return t.startsWith("http")?new URL(t):new URL(t,location.origin)}function j(t,e,n,o){let{url:a,body:l}=U(n,e,t),c={method:e};return l&&(c.body=l),fetch(a,c).then(p=>A(p,n,o))}function R(t,e,n,o){let a=o.getAttribute("s-target");if(o instanceof HTMLFormElement)return j(e,n,o,a);{let l={},c;if(t instanceof DragEvent){let p=t.dataTransfer?.getData("application/json");p&&(l["Content-Type"]="application/json",c=p)}return fetch(e,{method:n,headers:l,body:c}).then(p=>A(p,o,a))}}function T(t){let e=t.getAttribute("s-on");return e?e.split(/\s*\|\s*/).map(W).filter(Boolean):N(t)}function N(t){switch(t.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[{event:"appear"}]}}function W(t){let e=t.split(/\s+on\s+/);return e.length===1?{event:e[0]}:e.length===2?{event:e[0],selector:e[1]}:(console.warn(`Invalid event spec: ${t}`),null)}function D(t,e){if(!(e instanceof DragEvent)||!e.dataTransfer)return;if(e.type==="dragstart"){let a=t.getAttribute("s-drag-json"),l=t.getAttribute("s-drag-effect");a&&e.dataTransfer.setData("application/json",a),l&&(e.dataTransfer.effectAllowed=l)}let n=t.getAttribute("s-drop-class"),o=t.getAttribute("s-drop-effect");if(e.type==="dragover"){if(!o)return;e.preventDefault(),e.dataTransfer.dropEffect,n&&t.classList.add(n)}else e.type==="dragleave"&&n&&t.classList.remove(n)}function C(t){let e=t.getAttribute("s-emit");if(!e)return null;let n=e.split(/\s+after\s/);if(n.length===2){let o=n[0],a=parseFloat(n[1]);return!o||isNaN(a)?null:(n[1].endsWith("s")&&(a*=1e3),a=Math.round(a),{event:o,delay:a})}else return{event:n[0],delay:0}}function k(t){return t.getAttribute("s-eval")}function q(t,e,n){try{new Function("event",t).call(e,n)}catch(o){console.error("s-eval execution failed:",o)}}(function(){let t;function e(s,r){let u=s.getAttribute(`s-${r}`);return u?{url:u,method:r}:null}function n(s=document.body){return s.querySelectorAll("[s-get],[s-post],[s-put],[s-delete],[s-emit],[s-eval]")}function o(s){let r=s instanceof Event?s:new CustomEvent(s),u=n(),d=[],g=[];for(let i of u){let m=C(i),h=a(i),f=k(i);if(!m&&!h&&!f)continue;let E=T(i);for(let y of E)y.event===r.type&&(y.selector?d.push({event:r,element:i,emit:m,config:h,spec:y,eval:f}):g.push({event:r,element:i,emit:m,config:h,spec:y,eval:f}))}if(r.target&&r.target instanceof Element){let i=r.target;for(D(i,r);i;){let m=g.find(f=>f.element.isSameNode(i));m&&l(m);let h=d.filter(f=>i.matches(f.spec.selector));for(let f of h)l(f);if(r.type==="appear")break;if(i.parentElement)i=i.parentElement;else break}}else for(let i of[...d,...g])i.spec.event===r.type&&l(i)}function a(s){return e(s,"get")??e(s,"post")??e(s,"put")??e(s,"delete")}function l({event:s,element:r,config:u,emit:d,eval:g}){let i=r.getAttribute("s-confirm");if(!(i&&!confirm(i))&&(g&&q(g,r,s),d&&c(r,d),u)){let m=P(r),h=L(u.url,m);R(s,h,u.method,r).then(f=>{if(f.html!==null)for(let E of f.targets)E.innerHTML=f.html,v(E);else if(f.text!==null)for(let E of f.targets)E.textContent=f.text;else f.event&&o(f.event);r.dispatchEvent(new CustomEvent("slim:ok"))}).catch(f=>{console.error("Request failed:",f),r.dispatchEvent(new CustomEvent("slim:error"))}).finally(()=>{r.dispatchEvent(new CustomEvent("slim:done"))})}}function c(s,r){r.delay?setTimeout(()=>{s.parentElement&&o(r.event)},r.delay):o(r.event)}function p(s){for(let r of s)if(r.isIntersecting){let u=r.target;u.dispatchEvent(new CustomEvent("appear",{bubbles:!1})),t.unobserve(u)}}function b(){let s={root:null,threshold:0};t=new IntersectionObserver(p,s)}function v(s){let r=n(s);for(let u of r)T(u).some(i=>i.event==="appear")&&t.observe(u)}function S(){let s=["click","change","input","submit","appear","dragstart","dragover","dragleave","drop"];for(let r of s)document.body.addEventListener(r,u=>{u.type==="submit"&&u.preventDefault(),o(u)},{capture:!0})}function F(s){let r=document.body.getAttribute("s-ws");if(!r)return;let u=new WebSocket(r);u.onmessage=d=>{let g=d.data.toString();o(g)},u.onerror=d=>{console.warn("WebSocket error:",d),s()}}function w(){F(()=>{setTimeout(()=>w(),1e3)})}document.addEventListener("DOMContentLoaded",()=>{b(),S(),w(),v(document.body)})})();
