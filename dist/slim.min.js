function w(t){let e=new URLSearchParams,r=t,c=[];for(;r;)c.unshift(r),r=r.parentElement;for(let l of c){let u=l.getAttribute("s-query");u&&new URLSearchParams(u).forEach((h,v)=>e.set(v,h))}return e}function T(t,e){if(e.toString()==="")return t;let r=new URL(t,location.origin);return e.forEach((c,l)=>{r.searchParams.set(l,c)}),r.toString()}function b(t,e,r){if(t.headers.get("S-Refresh")==="true")return location.reload(),Promise.resolve({status:t.status,html:null,text:null,event:null,targets:[]});if(!t.ok)return Promise.reject();let l=t.headers.get("S-Target")||r,u=t.headers.get("S-Emit");return t.text().then(f=>{switch(t.headers.get("content-type")?.split(";")[0]){case"text/html":return{status:t.status,html:f,text:null,event:u,targets:R(e,l)};case"text/plain":return{status:t.status,html:null,text:f,event:u,targets:[]};default:return{status:t.status,html:null,text:null,event:u,targets:[]}}})}function R(t,e){if(!e)return[t];let r=document.querySelectorAll(e);return Array.from(r)}function L(t,e,r){let c=new FormData(t);if(e.toUpperCase()==="GET"){let l=C(r);for(let[u,f]of c.entries())f instanceof File||l.searchParams.append(u,f.toString());return{url:l.toString(),body:null}}else return{url:r,body:c}}function C(t){return t.startsWith("http")?new URL(t):new URL(t,location.origin)}function k(t,e,r,c){let{url:l,body:u}=L(r,e,t),f={method:e};return u&&(f.body=u),fetch(l,f).then(h=>b(h,r,c))}function A(t,e,r){let c=r.getAttribute("s-target");return r instanceof HTMLFormElement?k(t,e,r,c):fetch(t,{method:e}).then(l=>b(l,r,c))}function y(t){let e=t.getAttribute("s-on");return e?e.split(/\s*\|\s*/).map(U).filter(Boolean):q(t)}function q(t){switch(t.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[{event:"appear"}]}}function U(t){let e=t.split(/\s+on\s+/);return e.length===1?{event:e[0]}:e.length===2?{event:e[0],selector:e[1]}:(console.warn(`Invalid event spec: ${t}`),null)}(function(){let t;function e(n,o){let s=n.getAttribute(`s-${o}`);return s?{url:s,method:o}:null}function r(n=document.body){return n.querySelectorAll("[s-get],[s-post],[s-put],[s-delete],[s-emit]")}function c(n){let o=n instanceof Event?n:new CustomEvent(n),s=r(),p=[],d=[];for(let a of s){let i=a.getAttribute("s-emit"),m=l(a);if(!i&&!m)continue;let g=y(a);for(let E of g)E.event===o.type&&(E.selector?p.push({element:a,emit:i,config:m,spec:E}):d.push({element:a,emit:i,config:m,spec:E}))}if(o.target&&o.target instanceof Element){let a=o.target;for(;a;){let i=d.find(g=>g.element.isSameNode(a));i&&u(i);let m=p.filter(g=>a.matches(g.spec.selector));for(let g of m)u(g);if(a.parentElement)a=a.parentElement;else break}}else for(let a of[...p,...d])a.spec.event===o.type&&u(a)}function l(n){return e(n,"get")??e(n,"post")??e(n,"put")??e(n,"delete")}function u({element:n,config:o,emit:s}){let p=n.getAttribute("s-confirm");if(p&&!confirm(p))return;let d=w(n);if(s&&c(s),o){let a=T(o.url,d);A(a,o.method,n).then(i=>{if(i.html!==null)for(let m of i.targets)m.innerHTML=i.html,v(m);else if(i.text!==null)for(let m of i.targets)m.textContent=i.text;else i.event&&c(i.event);n.dispatchEvent(new CustomEvent("slim:ok"))}).catch(i=>{console.error("Request failed:",i),n.dispatchEvent(new CustomEvent("slim:error"))}).finally(()=>{n.dispatchEvent(new CustomEvent("slim:done"))})}}function f(n){for(let o of n)if(o.isIntersecting){let s=o.target;s.dispatchEvent(new CustomEvent("appear")),t.unobserve(s)}}function h(){let n={root:null,threshold:0};t=new IntersectionObserver(f,n)}function v(n){let o=r(n);for(let s of o)y(s).some(a=>a.event==="appear")&&t.observe(s)}function P(){let n=["click","change","input","submit","appear"];for(let o of n)document.body.addEventListener(o,s=>{s.type==="submit"&&s.preventDefault(),c(s)},{capture:!0})}function x(n){let o=document.body.getAttribute("s-ws");if(!o)return;let s=new WebSocket(o);s.onmessage=p=>{let d=p.data.toString();c(d)},s.onerror=p=>{console.warn("WebSocket error:",p),n()}}function S(){x(()=>{setTimeout(()=>S(),1e3)})}document.addEventListener("DOMContentLoaded",()=>{h(),P(),S(),v(document.body)})})();
