function O(e){let t=new URLSearchParams,n=e,s=[];for(;n;)s.unshift(n),n=n.parentElement;for(let i of s){let l=i.getAttribute("s-query");l&&new URLSearchParams(l).forEach((d,S)=>t.set(S,d))}if(e instanceof HTMLFormElement)return t;let o=Array.from(e.querySelectorAll("input, select, textarea")).reverse();for(let i of o){let l=i.getAttribute("name")??i.id;!l||!N(i)||t.set(l,i.value)}let c=e.getAttribute("name")??e.id;if(c){let i=N(e);i&&t.set(c,i)}return t}function N(e){return"value"in e?e.value:""}function k(e,t){if(t.toString()==="")return e;let n=new URL(e,location.origin);return t.forEach((s,o)=>{n.searchParams.set(o,s)}),n.toString()}function F(e,t){return Promise.resolve({status:e,html:null,text:null,event:null,targets:[],swapStrategy:t,pushUrl:null})}function C(e,t,n,s){if(e.headers.get("S-Refresh")==="true")return location.reload(),F(e.status,s);let o=e.headers.get("S-Redirect");if(o)return window.location.href=o,F(e.status,s);let i=e.headers.get("S-Target")||n,l=e.headers.get("S-Emit"),d=e.headers.get("S-Swap")==="outer"?"outer":s,S=e.headers.get("S-Push");return e.text().then(w=>{let L=e.headers.get("content-type")?.split(";")[0],b=D(t,i);switch(L){case"text/html":return{status:e.status,html:w,text:null,event:l,targets:b,swapStrategy:d,pushUrl:S};case"text/plain":return{status:e.status,html:null,text:w,event:l,targets:b,swapStrategy:d,pushUrl:S};default:return{status:e.status,html:null,text:null,event:l,targets:[],swapStrategy:d,pushUrl:S}}})}function D(e,t){if(!t)return[e];let n=document.querySelectorAll(t);return Array.from(n)}function J(e,t,n){let s=new FormData(e);if(t.toUpperCase()==="GET"){let o=_(n);for(let[c,i]of s.entries())i instanceof File||o.searchParams.append(c,i.toString());return{url:o.toString(),body:null}}else return{url:n,body:s}}function _(e){return e.startsWith("http")?new URL(e):new URL(e,location.origin)}function K(e,t,n,s,o){let{url:c,body:i}=J(n,t,e),l={method:t,redirect:"manual",mode:"same-origin"};i&&(l.body=i),l.headers||(l.headers={});let h=l.headers;return h["S-Location"]=window.location.href,fetch(c,l).then(d=>C(d,n,s,o))}function W(e){let{event:t,url:n,method:s,element:o,targetSelector:c,swapStrategy:i}=e;if(o instanceof HTMLFormElement)return K(n,s,o,c,i);{let l={},h;if(t instanceof DragEvent){let d=t.dataTransfer?.getData("application/json");d&&(l["Content-Type"]="application/json",h=d)}return l["S-Location"]=window.location.href,fetch(n,{method:s,headers:l,body:h,redirect:"manual",mode:"same-origin"}).then(d=>C(d,o,c,i))}}function q(e){let t=e.getAttribute("s-on");return t?t.split(/\s*\|\s*/).map(Y).filter(Boolean):X(e)}function X(e){switch(e.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[{event:"appear"}]}}function Y(e){let t=e.split(/\s+on\s+/);return t.length===1?{event:t[0]}:t.length===2?{event:t[0],selector:t[1]}:(console.warn(`Invalid event spec: ${e}`),null)}function j(e,t){if(!(t instanceof DragEvent)||!t.dataTransfer)return;if(t.type==="dragstart"){let o=e.getAttribute("s-drag-json"),c=e.getAttribute("s-drag-effect");o&&t.dataTransfer.setData("application/json",o),c&&(t.dataTransfer.effectAllowed=c)}let n=e.getAttribute("s-drop-class"),s=e.getAttribute("s-drop-effect");if(t.type==="dragover"){if(!s)return;t.preventDefault(),t.dataTransfer.dropEffect,n&&e.classList.add(n)}else t.type==="dragleave"&&n&&e.classList.remove(n)}function A(e){let t=parseFloat(e);if(isNaN(t))return null;let n=e.endsWith("s")?t*1e3:t;return Math.round(n)}function I(e){let t=e.getAttribute("s-emit");if(!t)return null;let n=t.split(/\s+after\s/);if(n.length===2){let s=n[0],o=A(n[1]);return!s||o===null?null:{event:s,delay:o}}else return{event:n[0],delay:0}}function Q(e){return e.getAttribute("s-eval")}function B(e,t,n){try{new Function("event",e).call(t,n)}catch(s){console.error("s-eval execution failed:",s)}}function V(e){return e.getAttribute("s-swap")==="outer"?"outer":"inner"}function Z(e,t,n){e.innerHTML=t,n(e)}function ee(e,t,n){let s=document.createElement("div");s.innerHTML=t;let o=[];for(;s.firstChild;){let c=s.firstChild;c.nodeType===Node.ELEMENT_NODE&&o.push(c),e.parentElement&&e.parentElement.insertBefore(c,e)}e.parentElement&&e.parentElement.removeChild(e);for(let c of o)n(c)}function x(e){let{content:t,element:n,targetSelector:s,swapStrategy:o,observeElementsWithAppearEvent:c}=e,i=D(n,s);for(let l of i)o==="outer"?ee(l,t,c):Z(l,t,c)}function G(e){return e.getAttribute("s-template")}function $(e){let{element:t,templateSelector:n,targetSelector:s,swapStrategy:o,observeElementsWithAppearEvent:c}=e;if(!n)return;let i=document.querySelector(n);i&&x({content:i.innerHTML,element:t,targetSelector:s,swapStrategy:o,observeElementsWithAppearEvent:c})}function z(e){return e.getAttribute("s-push")||null}function H(e){window.history.pushState({},"",e)}(function(){let e,t=new Map;function n(a,r){let f=a.getAttribute(`s-${r}`);return f?{url:f,method:r}:null}function s(a=document.body){return a.querySelectorAll("[s-get],[s-post],[s-put],[s-delete],[s-emit],[s-eval],[s-template],[s-push]")}function o(a){let r=a instanceof Event?a:new CustomEvent(a),f=s(),m=[],v=[];for(let u of f){let E=I(u),y=c(u),g=Q(u),T=G(u),P=u.getAttribute("s-target"),p=z(u);if(!E&&!y&&!g&&!T&&!p)continue;let R=q(u);for(let U of R){if(U.event!==r.type)continue;(U.selector?m:v).push({event:r,element:u,emitSpec:E,requestConfig:y,eventSpec:U,evalCode:g,templateSelector:T,targetSelector:P,swapStrategy:V(u),pushUrl:p})}}if(r.target&&r.target instanceof Element){let u=r.target;for(j(u,r);u;){let E=v.find(g=>g.element.isSameNode(u));E&&i(E);let y=m.filter(g=>u.matches(g.eventSpec.selector));for(let g of y)i(g);if(r.type==="appear")break;if(u.parentElement)u=u.parentElement;else break}}else for(let u of[...m,...v])u.eventSpec.event===r.type&&i(u)}function c(a){return n(a,"get")??n(a,"post")??n(a,"put")??n(a,"delete")}function i(a){let r=a.element.getAttribute("s-debounce");if(r){let f=A(r);if(f!==null){let m=t.get(a.element);m!==void 0&&clearTimeout(m),t.set(a.element,setTimeout(()=>{t.delete(a.element),l(a)},f));return}}l(a)}function l({event:a,element:r,requestConfig:f,emitSpec:m,evalCode:v,templateSelector:u,targetSelector:E,swapStrategy:y,pushUrl:g}){let T=r.getAttribute("s-confirm");if(!(T&&!confirm(T))){if(v&&B(v,r,a),g&&(H(g),o("location:change")),m&&h(r,m),f){let P={event:a,element:r,targetSelector:E,swapStrategy:y,method:f.method,url:k(f.url,O(r))};W(P).then(p=>{if(p.html!==null)x({content:p.html,element:r,targetSelector:E,swapStrategy:p.swapStrategy,observeElementsWithAppearEvent:w});else if(p.text!==null)for(let R of p.targets)R.textContent=p.text;else p.event&&o(p.event);p.pushUrl&&(H(p.pushUrl),o("location:change")),r.dispatchEvent(new CustomEvent("slim:ok"))}).catch(p=>{console.error("Request failed:",p),r.dispatchEvent(new CustomEvent("slim:error"))}).finally(()=>{r.dispatchEvent(new CustomEvent("slim:done"))})}u&&$({element:r,templateSelector:u,targetSelector:E,swapStrategy:y,observeElementsWithAppearEvent:w})}}function h(a,r){r.delay?setTimeout(()=>{a.parentElement&&o(r.event)},r.delay):o(r.event)}function d(a){for(let r of a)if(r.isIntersecting){let f=r.target;f.dispatchEvent(new CustomEvent("appear",{bubbles:!1})),e.unobserve(f)}}function S(){let a={root:null,threshold:0};e=new IntersectionObserver(d,a)}function w(a){let r=s(a);for(let f of r)q(f).some(u=>u.event==="appear")&&e.observe(f)}function M(){let a=["click","change","input","submit","appear","dragstart","dragover","dragleave","drop"];for(let r of a)document.body.addEventListener(r,f=>{f.type==="submit"&&f.preventDefault(),o(f)},{capture:!0});addEventListener("popstate",()=>{o("location:change")}),addEventListener("hashchange",()=>{o("hash:change")})}function L(a){let r=document.body.getAttribute("s-ws");if(!r)return;let f=new WebSocket(r);f.onmessage=m=>{let v=m.data.toString();o(v)},f.onerror=m=>{console.warn("WebSocket error:",m),a()}}function b(){L(()=>{setTimeout(()=>b(),1e3)})}window.slim={broadcastEvent:o},document.addEventListener("DOMContentLoaded",()=>{S(),M(),b(),w(document.body)})})();
