function y(e){let t=new URLSearchParams,n=e,s=[];for(;n;)s.unshift(n),n=n.parentElement;for(let a of s){let u=a.getAttribute("s-query");u&&new URLSearchParams(u).forEach((p,g)=>t.set(g,p))}return t}function E(e,t){if(t.toString()==="")return e;let n=new URL(e,location.origin);return t.forEach((s,a)=>{n.searchParams.set(a,s)}),n.toString()}function v(e,t,n){if(e.headers.get("S-Refresh")==="true")return location.reload(),Promise.resolve({status:e.status,html:null,event:null,targets:[]});let a=e.headers.get("S-Target")||n;return e.text().then(u=>{switch(e.headers.get("content-type")?.split(";")[0]){case"text/html":return{status:e.status,html:u,event:null,targets:P(t,a)};case"text/plain":return{status:e.status,html:null,event:u,targets:[]};default:return{status:e.status,html:null,event:null,targets:[]}}})}function P(e,t){if(!t)return[e];let n=document.querySelectorAll(t);return Array.from(n)}function R(e,t,n){let s=new FormData(e);if(t.toUpperCase()==="GET"){let a=L(n);for(let[u,l]of s.entries())l instanceof File||a.searchParams.append(u,l.toString());return{url:a.toString(),body:null}}else return{url:n,body:s}}function L(e){return e.startsWith("http")?new URL(e):new URL(e,location.origin)}function O(e,t,n,s){let{url:a,body:u}=R(n,t,e),l={method:t};return u&&(l.body=u),fetch(a,l).then(p=>v(p,n,s))}function S(e,t,n){let s=n.getAttribute("s-target");return n instanceof HTMLFormElement?O(e,t,n,s):fetch(e,{method:t}).then(a=>v(a,n,s))}function T(e,t,n){if(n.event!==t.type)return!1;let s=t.target;return n.selector?s.matches(n.selector):e.isSameNode(s)}function b(e){let t=e.getAttribute("s-on");return t?t.split(/\s*\|\s*/).map(U).filter(Boolean):q(e)}function q(e){switch(e.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[]}}function U(e){let t=e.split(/\s+/);return t.length===1?{event:t[0]}:t.length===3&&t[1]==="on"?{event:t[0],selector:t[2]}:(console.warn(`Invalid event spec: ${e}`),null)}(function(){let e;function t(r,o){let c=r.getAttribute(`s-${o}`);return c?{url:c,method:o}:null}function n(r=document.body){return r.querySelectorAll("[s-on]")}function s(r){let o;typeof r=="string"?o=new CustomEvent(r):o=r;let c=n();for(let i of c)a(i,o)}function a(r,o){if(r.getAttribute("s-emit")){o.preventDefault(),s(o);return}let i=t(r,"get")??t(r,"post")??t(r,"put")??t(r,"delete");if(!i)return;let{url:d,method:m}=i,f=b(r);for(let h of f)if(T(r,o,h)){u(d,m,r),o.preventDefault();break}}function u(r,o,c){let i=y(c),d=E(r,i),m=c.getAttribute("s-confirm");(!m||confirm(m))&&S(d,o,c).then(f=>{f.html!==null?f.targets.forEach(h=>{h.innerHTML=f.html,g(h)}):f.event&&s(f.event)}).catch(f=>{console.error("Request failed:",f)})}function l(r){for(let o of r)if(o.isIntersecting){let c=o.target,i=new CustomEvent("appear",{bubbles:!1,cancelable:!0});a(c,i),e.unobserve(c)}}function p(){let r={root:null,threshold:0};e=new IntersectionObserver(l,r)}function g(r){let o=n(r);for(let c of o)b(c).some(m=>m.event==="appear")&&e.observe(c)}function w(){let r=["click","change","input","submit"];for(let o of r)document.body.addEventListener(o,c=>{s(c)},{capture:!0})}function A(){let r=document.body.getAttribute("s-ws");if(!r)return;let o=new WebSocket(r);o.onmessage=c=>{let i=c.data.toString();s(i)},o.onerror=c=>{console.error("WebSocket error:",c)},o.onclose=()=>{console.log("WebSocket connection closed")}}document.addEventListener("DOMContentLoaded",()=>{p(),w(),A(),g(document.body)})})();
