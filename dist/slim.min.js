function P(t){let e=new URLSearchParams,n=t,o=[];for(;n;)o.unshift(n),n=n.parentElement;for(let c of o){let f=c.getAttribute("s-query");f&&new URLSearchParams(f).forEach((h,S)=>e.set(S,h))}if(t instanceof HTMLFormElement)return e;let s=Array.from(t.querySelectorAll("input, select, textarea")).reverse();for(let c of s){let f=c.getAttribute("name")??c.id;!f||!R(c)||e.set(f,c.value)}let i=t.getAttribute("name")??t.id;if(i){let c=R(t);c&&e.set(i,c)}return e}function R(t){return"value"in t?t.value:""}function C(t,e){if(e.toString()==="")return t;let n=new URL(t,location.origin);return e.forEach((o,s)=>{n.searchParams.set(s,o)}),n.toString()}function A(t,e,n){if(t.headers.get("S-Refresh")==="true")return location.reload(),Promise.resolve({status:t.status,html:null,text:null,event:null,targets:[]});if(!t.ok)return Promise.reject();let s=t.headers.get("S-Target")||n,i=t.headers.get("S-Emit");return t.text().then(c=>{let m=t.headers.get("content-type")?.split(";")[0],h=w(e,s);switch(m){case"text/html":return{status:t.status,html:c,text:null,event:i,targets:h};case"text/plain":return{status:t.status,html:null,text:c,event:i,targets:h};default:return{status:t.status,html:null,text:null,event:i,targets:[]}}})}function w(t,e){if(!e)return[t];let n=document.querySelectorAll(e);return Array.from(n)}function N(t,e,n){let o=new FormData(t);if(e.toUpperCase()==="GET"){let s=W(n);for(let[i,c]of o.entries())c instanceof File||s.searchParams.append(i,c.toString());return{url:s.toString(),body:null}}else return{url:n,body:o}}function W(t){return t.startsWith("http")?new URL(t):new URL(t,location.origin)}function I(t,e,n,o){let{url:s,body:i}=N(n,e,t),c={method:e};return i&&(c.body=i),fetch(s,c).then(f=>A(f,n,o))}function q(t){let{event:e,url:n,method:o,element:s,targetSelector:i}=t;if(s instanceof HTMLFormElement)return I(n,o,s,i);{let c={},f;if(e instanceof DragEvent){let m=e.dataTransfer?.getData("application/json");m&&(c["Content-Type"]="application/json",f=m)}return fetch(n,{method:o,headers:c,body:f}).then(m=>A(m,s,i))}}function x(t){let e=t.getAttribute("s-on");return e?e.split(/\s*\|\s*/).map(B).filter(Boolean):Q(t)}function Q(t){switch(t.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[{event:"appear"}]}}function B(t){let e=t.split(/\s+on\s+/);return e.length===1?{event:e[0]}:e.length===2?{event:e[0],selector:e[1]}:(console.warn(`Invalid event spec: ${t}`),null)}function D(t,e){if(!(e instanceof DragEvent)||!e.dataTransfer)return;if(e.type==="dragstart"){let s=t.getAttribute("s-drag-json"),i=t.getAttribute("s-drag-effect");s&&e.dataTransfer.setData("application/json",s),i&&(e.dataTransfer.effectAllowed=i)}let n=t.getAttribute("s-drop-class"),o=t.getAttribute("s-drop-effect");if(e.type==="dragover"){if(!o)return;e.preventDefault(),e.dataTransfer.dropEffect,n&&t.classList.add(n)}else e.type==="dragleave"&&n&&t.classList.remove(n)}function H(t){let e=t.getAttribute("s-emit");if(!e)return null;let n=e.split(/\s+after\s/);if(n.length===2){let o=n[0],s=parseFloat(n[1]);return!o||isNaN(s)?null:(n[1].endsWith("s")&&(s*=1e3),s=Math.round(s),{event:o,delay:s})}else return{event:n[0],delay:0}}function k(t){return t.getAttribute("s-eval")}function F(t,e,n){try{new Function("event",t).call(e,n)}catch(o){console.error("s-eval execution failed:",o)}}function U(t){return t.getAttribute("s-template")}function M(t){let{element:e,templateSelector:n,targetSelector:o}=t;if(!n)return;let s=document.querySelector(n);if(s){let i=w(e,o);for(let c of i)c.innerHTML=s.innerHTML}}(function(){let t;function e(a,r){let u=a.getAttribute(`s-${r}`);return u?{url:u,method:r}:null}function n(a=document.body){return a.querySelectorAll("[s-get],[s-post],[s-put],[s-delete],[s-emit],[s-eval],[s-template]")}function o(a){let r=a instanceof Event?a:new CustomEvent(a),u=n(),d=[],v=[];for(let l of u){let E=H(l),b=s(l),g=k(l),p=U(l),y=l.getAttribute("s-target");if(!E&&!b&&!g&&!p)continue;let j=x(l);for(let T of j){if(T.event!==r.type)continue;(T.selector?d:v).push({event:r,element:l,emitSpec:E,requestConfig:b,eventSpec:T,evalCode:g,templateSelector:p,targetSelector:y})}}if(r.target&&r.target instanceof Element){let l=r.target;for(D(l,r);l;){let E=v.find(g=>g.element.isSameNode(l));E&&i(E);let b=d.filter(g=>l.matches(g.eventSpec.selector));for(let g of b)i(g);if(r.type==="appear")break;if(l.parentElement)l=l.parentElement;else break}}else for(let l of[...d,...v])l.eventSpec.event===r.type&&i(l)}function s(a){return e(a,"get")??e(a,"post")??e(a,"put")??e(a,"delete")}function i({event:a,element:r,requestConfig:u,emitSpec:d,evalCode:v,templateSelector:l,targetSelector:E}){let b=r.getAttribute("s-confirm");if(!(b&&!confirm(b))){if(v&&F(v,r,a),d&&c(r,d),u){let g={event:a,element:r,targetSelector:E,method:u.method,url:C(u.url,P(r))};q(g).then(p=>{if(p.html!==null)for(let y of p.targets)y.innerHTML=p.html,h(y);else if(p.text!==null)for(let y of p.targets)y.textContent=p.text;else p.event&&o(p.event);r.dispatchEvent(new CustomEvent("slim:ok"))}).catch(p=>{console.error("Request failed:",p),r.dispatchEvent(new CustomEvent("slim:error"))}).finally(()=>{r.dispatchEvent(new CustomEvent("slim:done"))})}l&&(M({element:r,templateSelector:l,targetSelector:E}),h(r))}}function c(a,r){r.delay?setTimeout(()=>{a.parentElement&&o(r.event)},r.delay):o(r.event)}function f(a){for(let r of a)if(r.isIntersecting){let u=r.target;u.dispatchEvent(new CustomEvent("appear",{bubbles:!1})),t.unobserve(u)}}function m(){let a={root:null,threshold:0};t=new IntersectionObserver(f,a)}function h(a){let r=n(a);for(let u of r)x(u).some(l=>l.event==="appear")&&t.observe(u)}function S(){let a=["click","change","input","submit","appear","dragstart","dragover","dragleave","drop"];for(let r of a)document.body.addEventListener(r,u=>{u.type==="submit"&&u.preventDefault(),o(u)},{capture:!0})}function O(a){let r=document.body.getAttribute("s-ws");if(!r)return;let u=new WebSocket(r);u.onmessage=d=>{let v=d.data.toString();o(v)},u.onerror=d=>{console.warn("WebSocket error:",d),a()}}function L(){O(()=>{setTimeout(()=>L(),1e3)})}document.addEventListener("DOMContentLoaded",()=>{m(),S(),L(),h(document.body)})})();
