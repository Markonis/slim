function y(e){let t=new URLSearchParams,n=e,c=[];for(;n;)c.unshift(n),n=n.parentElement;for(let a of c){let u=a.getAttribute("s-query");u&&new URLSearchParams(u).forEach((m,g)=>t.set(g,m))}return t}function E(e,t){if(t.toString()==="")return e;let n=new URL(e,location.origin);return t.forEach((c,a)=>{n.searchParams.set(a,c)}),n.toString()}function v(e,t,n){if(e.headers.get("S-Refresh")==="true")return location.reload(),Promise.resolve({status:e.status,html:null,event:null,targets:[]});let a=e.headers.get("S-Target")||n;return e.text().then(u=>{switch(e.headers.get("content-type")?.split(";")[0]){case"text/html":return{status:e.status,html:u,event:null,targets:P(t,a)};case"text/plain":return{status:e.status,html:null,event:u,targets:[]};default:return{status:e.status,html:null,event:null,targets:[]}}})}function P(e,t){if(!t)return[e];let n=document.querySelectorAll(t);return Array.from(n)}function R(e,t,n){let c=new FormData(e);if(t.toUpperCase()==="GET"){let a=L(n);for(let[u,l]of c.entries())l instanceof File||a.searchParams.append(u,l.toString());return{url:a.toString(),body:null}}else return{url:n,body:c}}function L(e){return e.startsWith("http")?new URL(e):new URL(e,location.origin)}function q(e,t,n,c){let{url:a,body:u}=R(n,t,e),l={method:t};return u&&(l.body=u),fetch(a,l).then(m=>v(m,n,c))}function S(e,t,n){let c=n.getAttribute("s-target");return n instanceof HTMLFormElement?q(e,t,n,c):fetch(e,{method:t}).then(a=>v(a,n,c))}function T(e,t){return t.event!==e.type?!1:t.selector?e.target.matches(t.selector):!0}function b(e){let t=e.getAttribute("s-on");return t?t.split(/\s*\|\s*/).map(U).filter(Boolean):O(e)}function O(e){switch(e.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[]}}function U(e){let t=e.split(/\s+/);return t.length===1?{event:t[0]}:t.length===3&&t[1]==="on"?{event:t[0],selector:t[2]}:(console.warn(`Invalid event spec: ${e}`),null)}(function(){let e;function t(r,s){let o=r.getAttribute(`s-${s}`);return o?{url:o,method:s}:null}function n(r,s,o){let i=r.getAttribute("s-emit");if(i){s.preventDefault(),g(i);return}let d=t(r,"get")??t(r,"post")??t(r,"put")??t(r,"delete");if(d){let{url:f,method:p}=d,h=b(r);for(let w of h)if(T(s,w)){c(f,p,r),s.preventDefault();break}}else{if(!o)return;let f=r.parentElement;f&&n(f,s,!0)}}function c(r,s,o){let i=y(o),d=E(r,i),f=o.getAttribute("s-confirm");(!f||confirm(f))&&S(d,s,o).then(p=>{p.html!==null?p.targets.forEach(h=>{h.innerHTML=p.html,l(h)}):p.event&&g(p.event)}).catch(p=>{console.error("Request failed:",p)})}function a(r){for(let s of r)if(s.isIntersecting){let o=s.target,i=new CustomEvent("appear",{bubbles:!1,cancelable:!0});n(o,i,!1),e.unobserve(o)}}function u(){let r={root:null,threshold:0};e=new IntersectionObserver(a,r)}function l(r){let s=r.querySelectorAll("[s-on]");for(let o of s)b(o).some(f=>f.event==="appear")&&e.observe(o)}function m(){let r=["click","change","input","submit"];for(let s of r)document.body.addEventListener(s,o=>{n(o.target,o,!0)},{capture:!0})}function g(r){let s=document.querySelectorAll(`[s-on*="${r}"]`);for(let o of s){let i=new CustomEvent(r,{bubbles:!1,cancelable:!0});n(o,i,!1)}}function A(){let r=document.body.getAttribute("s-ws");if(!r)return;let s=new WebSocket(r);s.onmessage=o=>{let i=o.data.toString();g(i)},s.onerror=o=>{console.error("WebSocket error:",o)},s.onclose=()=>{console.log("WebSocket connection closed")}}document.addEventListener("DOMContentLoaded",()=>{u(),m(),A(),l(document.body)})})();
