function H(t){let e=new URLSearchParams,n=t,r=[];for(;n;)r.unshift(n),n=n.parentElement;for(let i of r){let u=i.getAttribute("s-query");u&&new URLSearchParams(u).forEach((p,v)=>e.set(v,p))}if(t instanceof HTMLFormElement)return e;let s=Array.from(t.querySelectorAll("input, select, textarea")).reverse();for(let i of s){let u=i.getAttribute("name")??i.id;!u||!q(i)||e.set(u,i.value)}let c=t.getAttribute("name")??t.id;if(c){let i=q(t);i&&e.set(c,i)}return e}function q(t){return"value"in t?t.value:""}function N(t,e){if(e.toString()==="")return t;let n=new URL(t,location.origin);return e.forEach((r,s)=>{n.searchParams.set(s,r)}),n.toString()}function O(t,e){return Promise.resolve({status:t,html:null,text:null,event:null,targets:[],swapStrategy:e,pushUrl:null})}function P(t,e,n,r){if(t.headers.get("S-Refresh")==="true")return location.reload(),O(t.status,r);if(t.status>=300&&t.status<400){let v=t.headers.get("Location");return v&&(window.location.href=v),O(t.status,r)}let c=t.headers.get("S-Target")||n,i=t.headers.get("S-Emit"),m=t.headers.get("S-Swap")==="outer"?"outer":r,p=t.headers.get("S-Push");return t.text().then(v=>{let b=t.headers.get("content-type")?.split(";")[0],a=R(e,c);switch(b){case"text/html":return{status:t.status,html:v,text:null,event:i,targets:a,swapStrategy:m,pushUrl:p};case"text/plain":return{status:t.status,html:null,text:v,event:i,targets:a,swapStrategy:m,pushUrl:p};default:return{status:t.status,html:null,text:null,event:i,targets:[],swapStrategy:m,pushUrl:p}}})}function R(t,e){if(!e)return[t];let n=document.querySelectorAll(e);return Array.from(n)}function G(t,e,n){let r=new FormData(t);if(e.toUpperCase()==="GET"){let s=$(n);for(let[c,i]of r.entries())i instanceof File||s.searchParams.append(c,i.toString());return{url:s.toString(),body:null}}else return{url:n,body:r}}function $(t){return t.startsWith("http")?new URL(t):new URL(t,location.origin)}function z(t,e,n,r,s){let{url:c,body:i}=G(n,e,t),u={method:e};i&&(u.body=i),u.headers||(u.headers={});let m=u.headers;return m["S-Location"]=window.location.href,fetch(c,u).then(p=>P(p,n,r,s))}function k(t){let{event:e,url:n,method:r,element:s,targetSelector:c,swapStrategy:i}=t;if(s instanceof HTMLFormElement)return z(n,r,s,c,i);{let u={},m;if(e instanceof DragEvent){let p=e.dataTransfer?.getData("application/json");p&&(u["Content-Type"]="application/json",m=p)}return u["S-Location"]=window.location.href,fetch(n,{method:r,headers:u,body:m}).then(p=>P(p,s,c,i))}}function U(t){let e=t.getAttribute("s-on");return e?e.split(/\s*\|\s*/).map(_).filter(Boolean):J(t)}function J(t){switch(t.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[{event:"appear"}]}}function _(t){let e=t.split(/\s+on\s+/);return e.length===1?{event:e[0]}:e.length===2?{event:e[0],selector:e[1]}:(console.warn(`Invalid event spec: ${t}`),null)}function F(t,e){if(!(e instanceof DragEvent)||!e.dataTransfer)return;if(e.type==="dragstart"){let s=t.getAttribute("s-drag-json"),c=t.getAttribute("s-drag-effect");s&&e.dataTransfer.setData("application/json",s),c&&(e.dataTransfer.effectAllowed=c)}let n=t.getAttribute("s-drop-class"),r=t.getAttribute("s-drop-effect");if(e.type==="dragover"){if(!r)return;e.preventDefault(),e.dataTransfer.dropEffect,n&&t.classList.add(n)}else e.type==="dragleave"&&n&&t.classList.remove(n)}function M(t){let e=t.getAttribute("s-emit");if(!e)return null;let n=e.split(/\s+after\s/);if(n.length===2){let r=n[0],s=parseFloat(n[1]);return!r||isNaN(s)?null:(n[1].endsWith("s")&&(s*=1e3),s=Math.round(s),{event:r,delay:s})}else return{event:n[0],delay:0}}function W(t){return t.getAttribute("s-eval")}function j(t,e,n){try{new Function("event",t).call(e,n)}catch(r){console.error("s-eval execution failed:",r)}}function I(t){return t.getAttribute("s-swap")==="outer"?"outer":"inner"}function K(t,e,n){t.innerHTML=e,n(t)}function X(t,e,n){let r=document.createElement("div");r.innerHTML=e;let s=[];for(;r.firstChild;){let c=r.firstChild;c.nodeType===Node.ELEMENT_NODE&&s.push(c),t.parentElement&&t.parentElement.insertBefore(c,t)}t.parentElement&&t.parentElement.removeChild(t);for(let c of s)n(c)}function T(t){let{content:e,element:n,targetSelector:r,swapStrategy:s,observeElementsWithAppearEvent:c}=t,i=R(n,r);for(let u of i)s==="outer"?X(u,e,c):K(u,e,c)}function Q(t){return t.getAttribute("s-template")}function B(t){let{element:e,templateSelector:n,targetSelector:r,swapStrategy:s,observeElementsWithAppearEvent:c}=t;if(!n)return;let i=document.querySelector(n);i&&T({content:i.innerHTML,element:e,targetSelector:r,swapStrategy:s,observeElementsWithAppearEvent:c})}function V(t){return t.getAttribute("s-push")||null}function C(t){window.history.pushState({},"",t)}(function(){let t;function e(a,o){let f=a.getAttribute(`s-${o}`);return f?{url:f,method:o}:null}function n(a=document.body){return a.querySelectorAll("[s-get],[s-post],[s-put],[s-delete],[s-emit],[s-eval],[s-template],[s-push]")}function r(a){let o=a instanceof Event?a:new CustomEvent(a),f=n(),h=[],E=[];for(let l of f){let S=M(l),y=s(l),g=W(l),w=Q(l),A=l.getAttribute("s-target"),d=V(l);if(!S&&!y&&!g&&!w&&!d)continue;let x=U(l);for(let L of x){if(L.event!==o.type)continue;(L.selector?h:E).push({event:o,element:l,emitSpec:S,requestConfig:y,eventSpec:L,evalCode:g,templateSelector:w,targetSelector:A,swapStrategy:I(l),pushUrl:d})}}if(o.target&&o.target instanceof Element){let l=o.target;for(F(l,o);l;){let S=E.find(g=>g.element.isSameNode(l));S&&c(S);let y=h.filter(g=>l.matches(g.eventSpec.selector));for(let g of y)c(g);if(o.type==="appear")break;if(l.parentElement)l=l.parentElement;else break}}else for(let l of[...h,...E])l.eventSpec.event===o.type&&c(l)}function s(a){return e(a,"get")??e(a,"post")??e(a,"put")??e(a,"delete")}function c({event:a,element:o,requestConfig:f,emitSpec:h,evalCode:E,templateSelector:l,targetSelector:S,swapStrategy:y,pushUrl:g}){let w=o.getAttribute("s-confirm");if(!(w&&!confirm(w))){if(E&&j(E,o,a),g&&(C(g),r("location:change")),h&&i(o,h),f){let A={event:a,element:o,targetSelector:S,swapStrategy:y,method:f.method,url:N(f.url,H(o))};k(A).then(d=>{if(d.html!==null)T({content:d.html,element:o,targetSelector:S,swapStrategy:d.swapStrategy,observeElementsWithAppearEvent:p});else if(d.text!==null)for(let x of d.targets)x.textContent=d.text;else d.event&&r(d.event);d.pushUrl&&(C(d.pushUrl),r("location:change")),o.dispatchEvent(new CustomEvent("slim:ok"))}).catch(d=>{console.error("Request failed:",d),o.dispatchEvent(new CustomEvent("slim:error"))}).finally(()=>{o.dispatchEvent(new CustomEvent("slim:done"))})}l&&B({element:o,templateSelector:l,targetSelector:S,swapStrategy:y,observeElementsWithAppearEvent:p})}}function i(a,o){o.delay?setTimeout(()=>{a.parentElement&&r(o.event)},o.delay):r(o.event)}function u(a){for(let o of a)if(o.isIntersecting){let f=o.target;f.dispatchEvent(new CustomEvent("appear",{bubbles:!1})),t.unobserve(f)}}function m(){let a={root:null,threshold:0};t=new IntersectionObserver(u,a)}function p(a){let o=n(a);for(let f of o)U(f).some(l=>l.event==="appear")&&t.observe(f)}function v(){let a=["click","change","input","submit","appear","dragstart","dragover","dragleave","drop"];for(let o of a)document.body.addEventListener(o,f=>{f.type==="submit"&&f.preventDefault(),r(f)},{capture:!0});addEventListener("popstate",()=>{r("location:change")}),addEventListener("hashchange",()=>{r("hash:change")})}function D(a){let o=document.body.getAttribute("s-ws");if(!o)return;let f=new WebSocket(o);f.onmessage=h=>{let E=h.data.toString();r(E)},f.onerror=h=>{console.warn("WebSocket error:",h),a()}}function b(){D(()=>{setTimeout(()=>b(),1e3)})}document.addEventListener("DOMContentLoaded",()=>{m(),v(),b(),p(document.body)})})();
