function y(e){let t=new URLSearchParams,n=e,c=[];for(;n;)c.unshift(n),n=n.parentElement;for(let a of c){let u=a.getAttribute("s-query");u&&new URLSearchParams(u).forEach((m,d)=>t.set(d,m))}return t}function E(e,t){if(t.toString()==="")return e;let n=new URL(e,location.origin);return t.forEach((c,a)=>{n.searchParams.set(a,c)}),n.toString()}function v(e,t,n){if(e.headers.get("S-Refresh")==="true")return location.reload(),Promise.resolve({status:e.status,html:null,event:null,targets:[]});let a=e.headers.get("S-Target")||n;return e.text().then(u=>{switch(e.headers.get("content-type")?.split(";")[0]){case"text/html":return{status:e.status,html:u,event:null,targets:A(t,a)};case"text/plain":return{status:e.status,html:null,event:u,targets:[]};default:return{status:e.status,html:null,event:null,targets:[]}}})}function A(e,t){if(!t)return[e];let n=document.querySelectorAll(t);return Array.from(n)}function P(e,t,n){let c=new FormData(e);if(t.toUpperCase()==="GET"){let a=R(n);for(let[u,l]of c.entries())l instanceof File||a.searchParams.append(u,l.toString());return{url:a.toString(),body:null}}else return{url:n,body:c}}function R(e){return e.startsWith("http")?new URL(e):new URL(e,location.origin)}function L(e,t,n,c){let{url:a,body:u}=P(n,t,e),l={method:t};return u&&(l.body=u),fetch(a,l).then(m=>v(m,n,c))}function S(e,t,n){let c=n.getAttribute("s-target");return n instanceof HTMLFormElement?L(e,t,n,c):fetch(e,{method:t}).then(a=>v(a,n,c))}function T(e,t){return t.event!==e.type?!1:t.selector?e.target.matches(t.selector):!0}function b(e){let t=e.getAttribute("s-on");return t?t.split(/\s*\|\s*/).map(O).filter(Boolean):q(e)}function q(e){switch(e.tagName){case"FORM":return[{event:"submit"}];case"BUTTON":return[{event:"click"}];case"SELECT":case"INPUT":return[{event:"change"}];default:return[]}}function O(e){let t=e.split(/\s+/);return t.length===1?{event:t[0]}:t.length===3&&t[1]==="on"?{event:t[0],selector:t[2]}:(console.warn(`Invalid event spec: ${e}`),null)}(function(){let e;function t(r,s){let o=r.getAttribute(`s-${s}`);return o?{url:o,method:s}:null}function n(r,s,o){let i=t(r,"get")??t(r,"post")??t(r,"put")??t(r,"delete");if(i){let{url:p,method:g}=i,f=b(r);for(let h of f)if(T(s,h)){c(p,g,r),s.preventDefault();break}}else{if(!o)return;let p=r.parentElement;p&&n(p,s,!0)}}function c(r,s,o){let i=y(o),p=E(r,i),g=o.getAttribute("s-confirm");(!g||confirm(g))&&S(p,s,o).then(f=>{f.html!==null?f.targets.forEach(h=>{h.innerHTML=f.html,l(h)}):f.event&&d(f.event)}).catch(f=>{console.error("Request failed:",f)})}function a(r){for(let s of r)if(s.isIntersecting){let o=s.target,i=new CustomEvent("appear",{bubbles:!1,cancelable:!0});n(o,i,!1),e.unobserve(o)}}function u(){let r={root:null,threshold:0};e=new IntersectionObserver(a,r)}function l(r){let s=r.querySelectorAll("[s-on]");for(let o of s)b(o).some(g=>g.event==="appear")&&e.observe(o)}function m(){let r=["click","change","input","submit"];for(let s of r)document.body.addEventListener(s,o=>{n(o.target,o,!0)},{capture:!0})}function d(r){let s=document.querySelectorAll(`[s-on*="${r}"]`);for(let o of s){let i=new CustomEvent(r,{bubbles:!1,cancelable:!0});n(o,i,!1)}}function w(){let r=document.body.getAttribute("s-ws");if(!r)return;let s=new WebSocket(r);s.onmessage=o=>{let i=o.data.toString();d(i)},s.onerror=o=>{console.error("WebSocket error:",o)},s.onclose=()=>{console.log("WebSocket connection closed")}}document.addEventListener("DOMContentLoaded",()=>{u(),m(),w(),l(document.body)})})();
